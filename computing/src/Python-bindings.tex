\input{./src/header.tex}

% languages
\definecolor{CColor}{rgb}{0.36, 0.54, 0.66}
\definecolor{CColorython}{rgb}{1.0, 0.49, 0.0}
\definecolor{PythonColor}{rgb}{0.09, 0.45, 0.27}
\definecolor{FortranColor}{HTML}{734F96}

% States and actions
\definecolor{BinaryColor}{rgb}{0.8, 0.8, 0.8}
\definecolor{CompileColor}{rgb}{0.89, 0.0, 0.13}
\definecolor{EmbedColor}{rgb}{1.0, 0.49, 0.0}
\definecolor{CythonizeColor}{rgb}{1.0, 0.6, 0.4}

\def\R{2}
\def\L{3}
\def\dx{6}
\def\dy{6}
\def\dyleg{\L/4}

\begin{circuitikz}[scale=1.0,
                   AnnotationStyle/.style={midway,above,align=center},
                   CodeStyle/.style={draw,rectangle, text centered,minimum width=\L cm, minimum height=\L cm, fill opacity=0.5, text opacity=1.0, draw opacity=1},
                   HeaderStyle/.style={draw,diamond,text centered,minimum width=\L cm,minimum height=\L cm,fill opacity=0.5,text opacity=1.0,draw opacity=1},
                   BinaryStyle/.style={draw,circle, text centered, minimum size=\L cm,fill opacity=0.5, text opacity=1.0, draw opacity=1},
                   HeaderArrow/.style={color=black, very thick, line width=0.5mm, dashed},
                   CompileArrow/.style={color=CompileColor, very thick, ->,line width=1mm},
                   LoadArrow/.style={->,color=PythonColor,ultra thick,line width=1.0mm},
                   EmbedArrow/.style={->,color=EmbedColor,ultra thick,line width=1.0mm},
                   EmbedBinaryArrow/.style={->,color=BinaryColor,ultra thick,line width=1.0mm},
                   CythonizeArrow/.style={->,color=CythonizeColor,ultra thick,line width=1.0mm},
                   LegendStyle/.style={draw,rectangle, minimum width=\L cm,text centered,fill opacity=0.5, text opacity=1.0, draw opacity=0, anchor=north west},
                   ]
    

    \coordinate (LegacyCoord) at (0,0);
    \coordinate (HeaderCoord) at ($(LegacyCoord)+(-\dx,0)$);
    \coordinate (SharedCoord) at ($(LegacyCoord)+(\dx,0)$);
    \coordinate (CtypesCoord) at ($(SharedCoord)+(\dx,0)$);
    \coordinate (PyinterpCoord) at ($(CtypesCoord)+(\dx,0)$);
    \coordinate (CapiCoord) at ($(SharedCoord)+(0,\dy)$);
    \coordinate (CapiExtCoord) at ($(CapiCoord)+(\dx*2,0)$);
    \coordinate (CythonCoord) at ($(SharedCoord)+(0,-\dy)$);
    \coordinate (CythonCCoord) at ($(CythonCoord)+(\dx,0)$);
    \coordinate (CythonExtCoord) at ($(CythonCCoord)+(\dx,0)$);
    \coordinate (TitleCoord) at ($(CapiCoord)+(0,\L)$);
    \coordinate (LegendCoord) at ($(TitleCoord)+(-4.5*\L,-\L/2,)$);
    
    % legacy code
    \node[CodeStyle,left color=CColor, right color=FortranColor,align=center] (LegacyNode) at (LegacyCoord) {Legacy Code \\ {\small \textit{C, C++ or Fortran}}};

    % header for legacy code
    \node[HeaderStyle,fill=CColor, text centered, align=center] (HeaderNode) at (HeaderCoord) {header.c \\ {\small \textit{Exposing a C API}}};

    % Comiled lib from legacy code
    \node[BinaryStyle,fill=BinaryColor,align=center] (SharedNode) at (SharedCoord) {Shared Library \\ {\small \textit{liblegacy.\{so,dylib,dll\}}}};

    % Wrapper with ctypes
    \node[CodeStyle, fill=PythonColor, align=center] (CtypesNode) at (CtypesCoord) {wrapper\_ctypes.py \\ {\small \textit{ctypes or CFFI or SWIG} } };

    % Python interpreter
    \node[CodeStyle, fill=PythonColor, align=center] (PyinterpNode) at (PyinterpCoord) {Python};

    % Wrapper with C API
    \node[CodeStyle, fill=CColor, align=center] (CapiNode) at (CapiCoord) {wrapper\_capi.c \\ {\small \textit{CPython C API} } };
    \node[BinaryStyle, fill=BinaryColor, align=center] (CapiExtNode) at (CapiExtCoord) {wrapper\_capi.\{so,dylib,pyd\} \\ {\small \textit{Python Module} } };

    % Wrapper with Cython
    \node[CodeStyle, left color=CColor, right color=PythonColor, align=center] (CythonNode) at (CythonCoord) {wrapper\_cython.pyx \\ {\small \textit{Cython} } };
    \node[CodeStyle, fill=CColor, align=center] (CythonCNode) at (CythonCCoord) {wrapper\_cython.c \\ {\small \textit{Autogenerated C code} } };
    \node[BinaryStyle, fill=BinaryColor, align=center] (CythonExtNode) at (CythonExtCoord) {wrapper\_cython.\{so,dylib,pyd\} \\ {\small \textit{Python Module} } };


    % ctypes workflow
    \draw[HeaderArrow] (HeaderNode.east) -- (LegacyNode.west);
    \draw[CompileArrow] (LegacyNode.east) -- (SharedNode.west) node[AnnotationStyle] {COMPILE};
    \draw[LoadArrow] (SharedNode.east) -- (CtypesNode.west) node[AnnotationStyle] {LOAD};
    \draw[LoadArrow] (CtypesNode.east) -- (PyinterpNode.west) node[AnnotationStyle] {IMPORT};

    % C API workflow
    \draw[EmbedBinaryArrow] (SharedNode.north) -- (CapiNode.south) node[AnnotationStyle, right,color=black!80] {EMBED \\ define shared library in setup.py};
    \draw[CompileArrow] (CapiNode.east) -- (CapiExtNode.west) node[midway, above] {COMPILE};
    \draw[LoadArrow] (CapiExtNode.south) -- (PyinterpNode.north) node[midway, left] {LOAD};

    % Cython workflow
    \draw[EmbedBinaryArrow] (SharedNode.south) -- (CythonNode.north) node[AnnotationStyle, right,color=black!80] {EMBED \\ define shared library in setup.py};
    \draw[CythonizeArrow] (CythonNode.east) -- (CythonCNode) node[AnnotationStyle, below] {CYTHONIZE};
    \draw[LoadArrow] (CythonCNode.east) -- (CythonExtNode) node[AnnotationStyle, below] {COMPILE};

    % Embed sources workflow
    \draw[EmbedArrow] (LegacyNode.north) |- (CapiNode.west) node[AnnotationStyle, above] {EMBED \\ define sources in setup.py \\ f2py is required if sources in Fortran};
    \draw[EmbedArrow] (LegacyNode.south) |- (CythonNode.west) node[AnnotationStyle, below] {EMBED \\ define sources in setup.py \\ f2py is required if sources in Fortran};


    % Legend
    \node[anchor=west] at (LegendCoord) {\Large \textsc{Legend}};
    \node[LegendStyle, fill=BinaryColor] at ($(LegendCoord)+(0,-\dyleg)$) {Binary Code};
    \node[LegendStyle, fill=CColor] at ($(LegendCoord)+(0,-2*\dyleg)$) {C Code};
    \node[LegendStyle, fill=FortranColor] at ($(LegendCoord)+(0,-3*\dyleg)$) {Fortran Code};
    \node[LegendStyle, fill=PythonColor] at ($(LegendCoord)+(0,-4*\dyleg)$) {Python Code};
    
    %TILE
    \node at (TitleCoord) {\Huge \textsc{Python Bindings}};

    
\end{circuitikz}

\input{./src/footer.tex}
